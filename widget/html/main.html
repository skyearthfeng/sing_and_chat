<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title>聊啦</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css" />
  <link rel="stylesheet" type="text/css" href="../css/common.css" />
</head>

<body>
  <div id="app" v-cloak>
    <div class="wrap flex-wrap flex-vertical">
      <header id="header" class=" border-bottom">
        <div v-if="index == 0" class="header-home">
          <div class="nav">
            <a href="javascript:;" v-bind:class="indexHome==0?'active':''" tapmode @click="setFrame(0)">关注</a>
            <a href="javascript:;" v-bind:class="indexHome==1?'active':''" tapmode @click="setFrame(1)">推荐</a>
            <a href="javascript:;" v-bind:class="indexHome==2?'active':''" tapmode @click="setFrame(2)">附近</a>
            <!-- <a href="javascript:;" v-bind:class="indexHome==2?'active':''" tapmode @click="setFrame(2)" v-cloak>榜单</a> -->
            <!-- <a href="javascript:;" v-bind:class="indexHome==3?'active':''" tapmode @click="setFrame(3)">约单</a> -->
            <!-- <a href="javascript:;" v-bind:class="indexHome==3?'active':''" tapmode @click="setFrame(3)">随心</a> -->
            <!-- <a href="javascript:;" v-bind:class="indexHome==3?'active':''" tapmode @click="setFrame(4)">分享有益</a> -->
          </div>
          <div class="search-wrap" tapmode @click="openWinSearch()">
            <i class="iconfont icon-search"></i>
          </div>
        </div>

        <!-- <div v-if="index == 1" class="header-message ">
          <div class="header-title">
            小视频
          </div> -->
        <!-- <div class="header-title">{{frames[index].title}}</div> -->
        <!-- <div class="nav header-left"> -->
        <!-- <a href="javascript:;" v-bind:class="indexVideo==0?'active':''" tapmode @click="setVideo(0)" class="nav-left">精彩</a> -->
        <!-- <a href="javascript:;" v-bind:class="indexVideo==1?'active':''" tapmode @click="setVideo(1)" class="nav-right">视讯</a> -->
        <!-- </div> -->
        <!-- <div @click="openUpload" class="header-right">
            <i class="iconfont icon-font-add1"></i>
          </div>
        </div> -->
        <!-- <div v-if="index == 2" class="header-wrap">
          <div class="header-title">{{frames[index].title}}</div>
        </div> -->
        <div v-if="index == 1" class="header-wrap">
          <div class="header-left" @click='foundRoom()'>
            <i class="iconfont icon-font-add1"></i>
          </div>
          <div class="header-title">{{frames[index].title}}</div>
          <div class="header-right">
            <i class="iconfont icon-search" @click='openChatSearch()'></i>
          </div>
        </div>
        <div v-if="index == 2" class="header-wrap">
          <!-- <div class="nav"> -->
          <div class="header-title">发布动态
            <!-- <div class="header-left" @click='empty'>清空</div> -->
            <div class="header-right" @click='postDynamic'>
              发布
            </div>
          </div>
          <!-- <a href="javascript:;" v-bind:class="indexMessage==1?'active':''" @click="setFramehome(1)">动态</a> -->
          <!-- </div> -->

        </div>
        <div v-if="index == 3" class="header-message">
          <!-- <div class="nav"> -->
          <div class="header-title">{{frames[index].title}}
            <div class="header-left" @click='empty'>清空</div>
            <div class="header-right" @click='ignore'>
              忽略未读
            </div>
          </div>
          <!-- <a href="javascript:;" v-bind:class="indexMessage==1?'active':''" @click="setFramehome(1)">动态</a> -->
          <!-- </div> -->

        </div>
        <div v-if="index == 4" class="header-wrap">
          <div class="header-title">{{frames[index].title}}</div>
          <div @click="openDetail" class="header-right">
            <img src="../image/see.png" alt="" class="see_detail">
          </div>
        </div>
      </header>
      <!-- <div class="adMain" id="adMain">

      </div> -->
      <div id="main" class="main flex-con"></div>
      <!-- <div id="footer">
        <ul class="flex-wrap">
          <li v-for="(item, i) in frames" :key="i" tapmode="hover" @click="tabBarSelected(i);"
            :class="['flex-con', index == i ? 'active' : '']">
            <i :class="['icon', 'icon-tab' + i]"></i>
            <span v-if="i == 2 && messageBadge" class="messageBadge"></span>
          </li>
        </ul>
      </!-->
    </div>
  </div>
</body>

</html>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/vue.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript">
  var app, NVTabBar;
  apiready = function () {
    // 设置禁止截屏
    // if (api.systemType == 'android') {
    //   api.setScreenSecure({
    //     secure: true
    //   });
    // }
    $api.fixStatusBar($api.dom('#header'));
    NVTabBar = api.require('NVTabBar');
    // strongApp = api.require('strongApp');
    api.setStatusBarStyle({
      style: 'dark'
    });
    app = new Vue({
      el: '#app',
      data: {
        // headShow:true,
        appName: api.appName,
        adList: [],
        frames: [{
            // name: 'home',
            title: api.appName,
            // url: 'home.html',
            bgColor: 'rgba(0,0,0,.2)',
            bounces: true,
          },
          // {
          //   // name: 'video',
          //   title: '短视频',
          //   // url: 'video.html',
          //   bgColor: 'rgba(0,0,0,.2)',
          //   bounces: true,
          // },
          //  {
          //   name: 'video_chat',
          //   title: '视频聊',
          //   url: 'video_chat.html',
          //   bgColor: 'rgba(0,0,0,.2)',
          //   bounces: false,
          //   pageParam: {
          //     statusBarHeight: api.safeArea.top
          //   }
          // },
          {
            name: 'chat',
            title: '聊天室',
            url: 'chat.html',
            bgColor: 'rgba(0,0,0,.2)',
            bounces: true,
          },
          {
            name: 'dynamic_post',
            title: '发布',
            url: 'dynamic_post.html',
            bgColor: 'rgba(0,0,0,.2)',
            bounces: true,
          },
          {
            name: 'message',
            title: '消息',
            url: 'message.html',
            bgColor: 'rgba(0,0,0,.2)',
            bounces: true
          },
          {
            name: 'my',
            title: '我的',
            url: 'my.html',
            bgColor: 'rgba(0,0,0,.2)',
            bounces: true,
          }
        ],
        index: !!$api.getStorage('index') ? $api.getStorage('index') : 0,
        curHomeBackTriggerTimes: 1,
        maxHomeBackTriggerTimes: 2,
        messageBadge: false,
        indexHome: 0,
        indexMessage: 0,
        indexVideo: 0,
        ad_height: '',

      },
      created: function () {
        var _this = this;
        // console.log($api.getStorage('deviceToken'))
        _this.checkUpdate();
        api.addEventListener({
          name: 'openWinVideoChat'
        }, function (ret, err) {
          _this.tabBarSelected(2);
        })
        api.addEventListener({
          name: 'cleanMessageBadge'
        }, function (ret, err) {
          _this.messageBadge = false;
        })

        api.addEventListener({
          name: 'resume'
        }, function (ret, err) {
          api.sendEvent({
            name: 'settingStatus'
          })
        })

        api.addEventListener({
          name: 'setGroupFrame'
        }, function () {
          _this.setFrame(2)
        })
        // strongApp.start({

        // }, function (ret, err) {
        //   if (ret) {
        //   } else {
        //   }
        // });
        api.addEventListener({
          name: 'pause'
        }, function (ret, err) {
          time1 = window.setInterval(function () {
            api.sendEvent({
              name: 'settingStatus'
            })
          }, 10000)
        });
        api.addEventListener({
          name: 'resume'
        }, function (ret, err) {
          clearInterval(time1)
        });

        api.addEventListener({
          name: 'pause'
        }, function (ret, err) {
          time2 = window.setInterval(function () {
            api.ajax({
              url: baseUrl + 'user/beat',
              method: 'post',
              headers: {
                token: $api.getStorage('deviceToken')
              },
              data: {
                values: {
                  uid: $api.getStorage('uid'),
                },
              }
            }, function (ret, err) {})
          }, 60000)
        });
        api.addEventListener({
          name: 'resume'
        }, function (ret, err) {
          clearInterval(time2)
        })
        // 下滑显示
        // api.addEventListener({
        //     name: 'dowmGlide'
        // }, function(ret, err) {
        //   _this.headShow=true

        //   api.setFrameGroupAttr({
        //       name: 'group1',
        //       rect: {
        //       x: 0,
        //       y:  $api.dom('#header').offsetHeight,
        //       w: 'auto',
        //       h: 'auto',

        //       marginBottom: $api.dom('#footer').offsetHeight,
        //     },
        //   });
        // });
        // // 上划隐藏
        // api.addEventListener({
        //     name: 'topGlide'
        // }, function(ret, err) {
        //   // alert(22)
        //   _this.headShow=false
        //   api.setFrameGroupAttr({
        //       name: 'group1',
        //       rect: {
        //       x: 0,
        //       y:  $api.dom('#header').offsetHeight,
        //       w: 'auto',
        //       h: 'auto',
        //       marginTop: $api.dom('#header').offsetHeight,
        //       marginBottom: $api.dom('#footer').offsetHeight,
        //     },
        //   });
        // });
      },
      mounted: function () {
        var _this = this
        this.init();
        // console.log($api.getStorage('deviceToken'))
        // this.login_tost();
        this.androidFinishApp();
        this.funIniGroup();
        // this.beat();
        this.tabBarSelected(1)
        if (!!$api.getStorage('token')) {
          this.rongConnect();
        }
        $api.setStorage('roomid', -1)
        $api.setStorage('chatShow', 0)
        //隐藏显示底部
        api.addEventListener({
          name: 'showNavBar',
        }, function (ret, err) {
          _this.showNavBar(ret.value.index)
        })
        api.requestPermission({
          list: ['microphone'],
          code: 1
        }, function (ret, err) {
          // api.alert({
          //     msg:JSON.stringify(ret)
          // });
        });
        //心跳 来识别是否在线
        // setTimeout(function(){
        //   api.ajax({
        //     url: baseUrl + 'user/beat',
        //     method: 'post',
        //     headers: {
        //       token: $api.getStorage('deviceToken')
        //     },
        //     data: {
        //       values: {
        //         uid: $api.getStorage('uid'),
        //       },
        //     }
        //   }, function (ret, err) {
        //     console.log(err)
        //   })
        // },100)
        // setInterval(function(){
        //   api.ajax({
        //     url: baseUrl + 'user/beat',
        //     method: 'post',
        //     headers: {
        //       token: $api.getStorage('deviceToken')
        //     },
        //     data: {
        //       values: {
        //         uid: $api.getStorage('uid'),
        //       },
        //     }
        //   }, function (ret, err) {
        //     alert(ret.message[0])
        //     console.log(err)
        //   })
        // },1000)
      },
      methods: {
        init() {
          var _this = this
          var marginB = api.systemType == 'android' ? 15 : 20
          NVTabBar.open({
            styles: {
              bg: '#fff',
              //bg:"widget://image/NVTabBar/tabbar_bg.png",
              h: 55,
              dividingLine: {
                width: 0.5,
                color: '#ddd'
              },
              badge: {
                bgColor: '#fff',
                numColor: '#fff',
                size: 6.0,
                centerX: 40,
                centerY: 6
              }
            },
            items: [{
              w: api.winWidth / 5.0,
              bg: {
                marginB: -2,
                // image: 'rgba(200,200,200,0.6)'
              },
              iconRect: {
                w: 20.0,
                h: 20.0,
              },
              icon: {
                normal: 'widget://image/icon_navigation_home_unselected_gaitubao_com_100x100.png',
                highlight: 'widget://image/icon_navigation_home_selected.png',
                selected: 'widget://image/icon_navigation_home_selected.png'
              },
              title: {
                text: '动态',
                size: 12.0,
                normal: '#696969',
                selected: '#eb4f38',
                marginB: 6.0
              }
            }, {
              w: api.winWidth / 5.0,
              bg: {
                marginB: -2,
                image: ''
              },
              iconRect: {
                w: 20.0,
                h: 20.0,
              },
              icon: {
                normal: 'widget://image/icon_navigation_focus_unselected_gaitubao_com_100x100.png',
                highlight: 'widget://image/icon_navigation_focus_unselected_gaitubao_com_100x100.png',
                selected: 'widget://image/icon_navigation_focus_selected_gaitubao_com_100x100.png'
              },
              title: {
                text: '发现',
                size: 12.0,
                normal: '#696969',
                selected: '#eb4f38',
                marginB: 6.0
              }
            }, {
              w: api.winWidth / 5.5,
              bg: {
                marginB: marginB,
                // image: 'widget://image/quick_icon_gaitubao_com_280x280.png' //中间背景图
              },
              iconRect: {
                w: 76,
                h: 76,
              },
              icon: {
                normal: 'widget://image/quick_icon_gaitubao_com_280x280.png',
                highlight: 'widget://image/quick_icon_gaitubao_com_280x280.png',
                selected: 'widget://image/quick_icon_gaitubao_com_280x280.png'
              },
              title: {
                text: '发布',
                size: 12.0,
                normal: '#696969',
                selected: '#696969',
                marginB: 6.0
              }
            }, {
              w: api.winWidth / 5.0,
              bg: {
                marginB: -2,
                // image: 'rgba(200,20,0,0.6)'
              },
              iconRect: {
                w: 20.0,
                h: 20.0,
              },
              icon: {
                normal: 'widget://image/icon_navigation_message_unselected_gaitubao_com_100x110.png',
                highlight: 'widget://image/icon_navigation_message_selected_gaitubao_com_100x110.png',
                selected: 'widget://image/icon_navigation_message_selected_gaitubao_com_100x110.png'
              },
              title: {
                text: '消息',
                size: 12.0,
                normal: '#696969',
                selected: '#eb4f38',
                marginB: 6.0
              }
            }, {
              w: api.winWidth / 5.0,
              bg: {
                marginB: -2,
                // image: 'rgba(220,0,220,0.7)'
              },
              iconRect: {
                w: 20.0,
                h: 20.0,
              },
              icon: {
                normal: 'widget://image/icon_navigation_mine_unselected_gaitubao_com_69x100.png',
                highlight: 'widget://image/icon_navigation_mine_selected_gaitubao_com_69x100.png',
                selected: 'widget://image/icon_navigation_mine_selected_gaitubao_com_69x100.png'
              },
              title: {
                text: '我的',
                size: 12.0,
                normal: '#696969',
                selected: '#eb4f38',
                marginB: 6.0
              }
            }],
            selectedIndex: 1
          }, function (ret, err) {
            // setTimeout(function () {
            // NVTabBar.bringToFront()
            // },1000)
            if(ret.index!=undefined){
              _this.tabBarSelected(ret.index)
            }
          })
        },
        //点击跳转聊天室搜索
        openChatSearch() {
          api.openWin({
            name: 'chat_search',
            url: 'chat_search.html',
          })
        },
        foundRoom() {
          axios1('dlchat/api_room/my', 'post', {
              token: $api.getStorage('deviceToken'),
              user_id: $api.getStorage('uid')
            },
            function (res, err) {
              if (res.code == 1) {
                if (res.data.status == 1) {
                  if ($api.getStorage('roomid') == res.data.roomid) {
                    api.sendEvent({
                      name: 'showNavBar',
                      extra: {
                        index: 0
                      }
                    })
                    api.setFrameAttr({
                      name: 'chat_detail',
                      hidden: false,
                      rect: {
                        x: 0, //左上角x坐标
                        y: 0, //左上角y坐标
                        w: api.winWidth, //宽度，若传'auto'，页面从x位置开始自动充满父页面宽度
                        h: api.winHeight //高度，若传'auto'，页面从y位置开始自动充满父页面高
                      }
                    })
                    api.setFrameAttr({
                      name: 'chat_music_frm',
                      hidden: false
                    })
                  } else {
                    api.sendEvent({
                      name: 'chatClose'
                    })
                    setTimeout(() => {
                      // var creater = userID == $api.getStorage('uid')
                      api.openFrame({
                        name: 'chat_detail',
                        url: 'chat_detail.html',
                        bgColor: 'widget://img/ic_bg_room_notice.png',
                        // singleInstance:true,
                        // singleInstance: true,
                        // reload:true,
                        pageParam: {
                          roomid: res.data.roomid,
                        }
                      })
                    }, 500)
                  }
                  // api.openWin({
                  //   name: 'chat_detail',
                  //   url: 'chat_detail.html',
                  //   pageParam: {
                  //     roomid: res.data.roomid,
                  //     creater: true
                  //   }
                  // })
                }
              } else {
                api.openWin({
                  name: 'chat_found',
                  url: 'chat_found.html'
                })
              }
            }
          )
        },
        //心跳 来识别是否在线
        beat: function () {
          setTimeout(function () {
            api.ajax({
              url: baseUrl + 'user/beat',
              method: 'post',
              headers: {
                token: $api.getStorage('deviceToken')
              },
              data: {
                values: {
                  uid: $api.getStorage('uid'),
                },
              }
            }, function (ret, err) {})
          }, 100)
          setInterval(function () {
            api.ajax({
              url: baseUrl + 'user/beat',
              method: 'post',
              headers: {
                token: $api.getStorage('deviceToken')
              },
              data: {
                values: {
                  uid: $api.getStorage('uid'),
                },
              }
            }, function (ret, err) {})
          }, 60000)
        },
        //清空消息
        empty: function () {
          api.sendEvent({
            name: 'Conversations'
          })
        },
        //忽略未读消息
        ignore: function () {
          api.sendEvent({
            name: 'IgnoreUnread'
          })
        },
        login_tost: function () {
          var _this = this;
          api.ajax({
            url: baseUrl + 'ad/index',
            method: 'get',
            headers: {
              token: $api.getStorage('deviceToken')
            },
            data: {
              values: {
                uid: $api.getStorage('uid'),
                type: 'login_tost'
              },
            }
          }, function (ret, err) {
            _this.adList = ret.data;
            if (ret.data[0].category.ad_height) {
              _this.ad_height = ret.data[0].category.ad_height;
              _this.ad()
            }

          })
        },
        ad: function () {
          var ad_offset = $api.offset($api.byId('adMain'));
          api.openFrame({
            name: 'login_tost',
            url: 'login_tost.html',
            rect: {
              x: 0,
              y: 200,
              w: window.screen.width,
              h: this.ad_height,
              // marginTop:50,
            },
            pageParam: this.adList

          });
        },
        // 检查app版本更新
        checkUpdate: function () {
          var mam = api.require('mam');
          mam.checkUpdate(function (ret, err) {
            if (ret) {
              var result = ret.result;
              if (result.update) {
                var str = '新版本号:' + result.version + ';\n更新内容:\n' + result.updateTip + ';\n发布时间:' + result
                  .time;
                if (result.closed) {
                  api.alert({
                    title: '有新版本更新',
                    msg: str,
                  }, function (ret, err) {
                    if (ret.buttonIndex == 1) {
                      if (api.systemType == "android") {
                        api.download({
                          url: result.source,
                          report: true
                        }, function (ret, err) {
                          if (ret && 0 == ret.state) {
                            api.showProgress({
                              title: ret.percent + "%",
                              text: ''
                            });
                          }
                          if (ret && 1 == ret.state) {
                            /* 下载完成 */
                            api.hideProgress();
                            api.installApp({
                              appUri: ret.savePath
                            });
                          }
                        });
                      }
                      if (api.systemType == "ios") {
                        api.installApp({
                          appUri: result.source
                        });
                      }
                    }
                  });
                } else {
                  api.confirm({
                    title: '有新版本推送，是否下载安装',
                    msg: str,
                    buttons: ['确定', '下次再说']
                  }, function (ret, err) {
                    if (ret.buttonIndex == 1) {
                      if (api.systemType == "android") {
                        api.download({
                          url: result.source,
                          report: true
                        }, function (ret, err) {
                          if (ret && 0 == ret.state) {
                            api.showProgress({
                              title: ret.percent + "%",
                              text: ''
                            });
                          }
                          if (ret && 1 == ret.state) {
                            /* 下载完成 */
                            api.hideProgress();
                            api.installApp({
                              appUri: ret.savePath
                            });
                          }
                        });
                      }
                      if (api.systemType == "ios") {
                        api.installApp({
                          appUri: result.source
                        });
                      }
                    }
                  });
                }
              } else {
                if (result.closed) {
                  // 无更新，强制关闭
                  api.alert({
                    title: '无新的版本',
                    msg: '应用已强制关闭',
                  }, function (ret, err) {
                    if (ret.buttonIndex == 1) {
                      api.closeWidget({
                        id: api.appId,
                        silent: true
                      });
                    }
                  });
                }
              }
            }
          });
        },

        //发表动态
        // publish: function () {
        //   api.openWin({
        //     name: 'dynamic_post',
        //     url: 'dynamic_post.html',
        //     slidBackEnabled: false
        //   })
        // },

        // 点击返回两次退出应用
        androidFinishApp: function () {
          var _this = this;
          api.addEventListener({
            name: 'keyback'
          }, function (ret, err) {
            if ($api.getStorage('chatShow') == 0) {
              if (_this.curHomeBackTriggerTimes === _this.maxHomeBackTriggerTimes) {
                api.sendEvent({
                  name: 'chatClose'
                })
                api.closeWidget({
                  id: api.appId,
                  silent: true
                });
              } else {
                api.toast({
                  msg: api.appName + '：再按一次退出应用'
                })
              }
              _this.curHomeBackTriggerTimes++;
              setTimeout(function () {
                _this.curHomeBackTriggerTimes--;
              }, 1000);
            } else {
              api.sendEvent({
                name: 'chatHidden'
              })
              // api.setFrameAttr({
              //     name: 'chat_detail',
              //     hidden: true
              // })
            }
          })
        },

        funIniGroup: function () {
          api.openFrameGroup({
            name: 'group',
            scrollEnabled: false,
            rect: {
              x: 0,
              y: $api.dom('#header').offsetHeight,
              w: api.winWidth,
              h: $api.dom('#main').offsetHeight
            },
            index: this.index,
            frames: this.frames,
            preload: 0,
          }, function (ret, err) {});
        },
        tabBarSelected: function (index) {
          var _this = this
          if (index == 2) {
            api.closeFrame({
              name: 'login_tost'
            })
          }
          if (index == 0) {
            _this.openWinRankingList()
          }
          if (index == 1) {
            api.setFrameAttr({
              name: 'chat_detail',
              hidden: true
            })
          }
          // if(){

          // }
          // if (index == 1) {
          //   _this.openVideo()
          // }
          if (index != 0) {
            api.setFrameGroupAttr({
              name: 'group1',
              hidden: true
            })
          }
          // if (index != 1) {
          //   api.setFrameGroupAttr({
          //     name: 'indexVideo',
          //     hidden: true
          //   });;
          // }
          // if (index == 3) {
          //   _this.openMessage()
          // }
          // if (index != 3) {
          //   api.setFrameGroupAttr({
          //       name: 'indexMessage',
          //       hidden: true
          //   });;
          // }
          NVTabBar.bringToFront()
          if (index == this.index) {
            return false;
          } else {
            this.index = index;
            $api.setStorage('index', index);
            api.setFrameGroupIndex({
              name: 'group',
              index: index
            })
            if (index != 2) {
              api.closeFrame({
                name: 'videoChatFrame1'
              });
              api.closeFrame({
                name: 'videoChatFrame2'
              });
              api.closeFrame({
                name: 'videoChatFrame3'
              });
              api.closeFrame({
                name: 'videoChatFrame1_loading'
              });
              api.closeFrame({
                name: 'videoChatFrame2_loading'
              });
              api.closeFrame({
                name: 'videoChatFrame3_loading'
              });
            } else {
              api.sendEvent({
                name: 'refreshVideoChat'
              })
            }
          }
        },
        //显示隐藏底部菜单
        showNavBar(index) {
          if (index == 1) {
            NVTabBar.show({
              animation: false
            });
          } else {
            NVTabBar.hide({
              animation: false
            });
          }
        },

        // 连接融云IM 设置接收消息监听器
        rongConnect: function () {
          var _this = this;
          rong = api.require('rongCloud2');
          rong.init(function (ret, err) {
            // console.log(JSON.stringify(err))
            if (ret.status == 'success') {
              rong.connect({
                token: $api.getStorage('token')
              }, function (ret, err) {
                console.log(JSON.stringify(ret))
                console.log(JSON.stringify(err))
                if (err) {
                  switch (err.code) {
                    case 31003:
                      api.toast({
                        msg: '服务器不可用'
                      });
                      break;
                    case 31004:
                      api.toast({
                        msg: '错误的令牌（Token）'
                      });
                      break;
                    case 31002:
                      api.toast({
                        msg: '错误的 AppKey'
                      });
                      break;
                    case 33002:
                      api.toast({
                        msg: '服务端数据库错误'
                      });
                      break;
                    case 31000:
                      api.toast({
                        msg: '服务器超时'
                      });
                      break;
                    default:
                      break;
                  }
                }
                if (ret.status == 'success') {
                  rong.setOnReceiveMessageListener(function (ret, err) {
                    console.log(JSON.stringify(ret))
                    if (ret.result.message.objectName == 'RC:CmdMsg') {
                      if (ret.result.message.content.name == 'loginOut') {
                        api.alert({
                          title: '警告',
                          msg: '此账号已违规!'
                        }, function (ret, err) {
                          if (ret.buttonIndex == 1) {
                            api.ajax({
                              url: baseUrl + 'oauth/logout',
                              method: 'get',
                              headers: {
                                token: $api.getStorage('deviceToken')
                              },
                              data: {
                                values: {
                                  uid: $api.getStorage('uid')
                                },
                              }
                            }, function (ret, err) {
                              if (ret && ret.status == 200) {
                                $api.rmStorage('uid');
                                $api.rmStorage('uname');
                                $api.rmStorage('uavatar');
                                $api.rmStorage('umobile');
                                $api.rmStorage('token');
                                $api.rmStorage('index');
                                rong.disconnect({
                                  isReceivePush: false
                                }, function (ret, err) {});
                                api.closeToWin({
                                  name: 'root'
                                });
                              }
                            });
                          }
                        });
                      }
                      if (ret.result.message.content.name == 'voiceCall' || ret.result.message
                        .content
                        .name == 'videoCall') {
                        if ((ret.result.message.receivedTime - ret.result.message.sentTime) >
                          30000) {
                          api.toast({
                            msg: '您有一个未接电话',
                            duration: 3000,
                            location: 'bottom'
                          });
                          $api.setStorage('index', 3);
                          api.setFrameGroupIndex({
                            name: 'group',
                            index: 3
                          });
                          return false;
                        }
                        api.closeWin({
                          name: 'call1'
                        });
                        setTimeout(
                          function () {
                            api.closeWin({
                              name: 'answer1'
                            })
                          }, 200)
                        setTimeout(function () {
                          api.openWin({
                            name: 'answer1',
                            url: 'answer1.html',
                            slidBackEnabled: false,
                            pageParam: ret.result.message.content
                          });
                        }, 500)
                        // 接到语音通话邀请

                      }
                      if (ret.result.message.content.name == 'hangUp') {
                        // 挂断
                        api.sendEvent({
                          name: 'hangUp',
                          extra: ret
                        });
                      }
                      if (ret.result.message.content.name == 'answer') {
                        // 接听
                        api.sendEvent({
                          name: 'answer',
                          extra: ret
                        });
                      }
                      if (ret.result.message.content.name == 'give_gift_notice_private') {
                        // 1v1赠送礼物显示通知
                        if ((ret.result.message.receivedTime - ret.result.message.sentTime) >
                          30000) {
                          api.toast({
                            msg: '您收到礼物了',
                            duration: 2000,
                            location: 'bottom'
                          });
                          $api.setStorage('index', 3);
                          api.setFrameGroupIndex({
                            name: 'group',
                            index: 3
                          });
                          return false;
                        }
                        api.sendEvent({
                          name: 'give_gift_notice_private',
                          extra: ret
                        });
                      }
                    } else {
                      api.sendEvent({
                        name: 'messageBadge',
                      });
                      _this.messageBadge = true;
                      api.sendEvent({
                        name: 'updateConversationList',
                        extra: ret
                      });
                      api.sendEvent({
                        name: 'updateIM',
                        extra: ret
                      })
                    }
                    // api.alert({
                    // 	title: 'setOnReceiveMessageListener',
                    // 	msg: JSON.stringify(ret)
                    // })
                  })
                }
              });
            } else {
              if (err.code == -10002) {
                api.toast({
                  msg: 'appKey参数错误'
                });
              }
            }
          });
        },
        openCreate() {
          api.openWin({
            name: 'createRoom',
            url: 'create_room.html',
            animation: {
              type: 'movein',
              subType: 'from_right'
            }
          })
        },
        //  打开搜索
        openWinSearch: function () {
          api.openWin({
            name: 'search',
            url: 'search.html',
            slidBackEnabled: false
          });
        },

        // 上传图片视频
        openUpload: function () {
          api.openWin({
            name: 'video_upload1',
            url: 'video_upload1.html',
            slidBackEnabled: false,
          });
        },

        //消息Tab切换
        // openMessage: function () {
        //   var _this = this;
        //   api.openFrameGroup({
        //     name: 'indexMessage',
        //     rect: {
        //       x: 0,
        //       y: $api.dom('#header').offsetHeight,
        //       w: 'auto',
        //       h: 'auto',
        //       marginBottom: $api.dom('#footer').offsetHeight,
        //     },
        //     frames: [{
        //       name: 'message',
        //       url: 'message.html',
        //       bgColor: '#fff'
        //     }, {
        //       name: 'dynamic.html',
        //       url: 'dynamic.html',
        //       bgColor: '#fff'
        //     }]
        //   }, function (ret, err) {
        //     _this.indexMessage = ret.index;
        //   })
        // },

        postDynamic() {
          api.execScript({
            frameName: 'dynamic_post',
            script: 'app.post()'
          });
        },

        openVideo: function () {
          var _this = this;
          api.openFrameGroup({
            name: 'indexVideo',
            rect: {
              x: 0,
              y: $api.dom('#header').offsetHeight,
              w: 'auto',
              h: 'auto',
              marginBottom: $api.dom('#footer').offsetHeight,
            },
            frames: [{
              name: 'video',
              url: 'video.html',
              bgColor: '#fff'
            }, {
              name: 'video_length.html',
              url: 'video_length.html',
              bgColor: '#fff'
            }]
          }, function (ret, err) {
            _this.indexVideo = ret.index;
          })
        },

        //首页Tab切换
        openWinRankingList: function () {
          var _this = this;
          api.openFrameGroup({
            name: 'group1',
            index: 1,
            preload: 2,
            rect: {
              x: 0,
              y: $api.dom('#header').offsetHeight,
              w: 'auto',
              h: 'auto',
              marginBottom: 50,
            },
            frames: [{
                name: 'follow',
                url: 'follow.html',
                bgColor: '#fff'
              }, {
                name: 'video_1',
                url: 'video_1.html',
                bgColor: '#fff'
              }, {
                name: 'nearby_frame',
                url: 'nearby_frame.html',
                bgColor: '#fff'
              },
              // {
              //   name: 'about',
              //   url: 'about_list.html',
              //   bgColor: '#fff'
              // },
              // {
              //   name: 'random',
              //   url: 'random.html',
              //   bgColor: '#fff'
              // },
              // {
              //   name: 'share',
              //   url: 'share.html',
              //   bgColor: '#fff'
              // }
            ]
          }, function (ret, err) {
            _this.indexHome = ret.index;
            if (ret.index == 4) {
              api.setFrameGroupIndex({
                name: 'group1',
                index: 4,
                reload: true,
              })
            }
            // api.sendFrameToBack({
            //     from: 'group1',
            // });
            // NVTabBar.bringToFront();
          })
          // api.sendFrameToBack({
          //       from: 'group1',
          //   });
          NVTabBar.bringToFront()
        },

        //首页点击切换Tab
        setFrame: function (index) {
          api.setFrameGroupIndex({
            name: 'group1',
            index: index
          })


        },
        // //视频点击切换Tab
        setVideo: function (index) {
          api.setFrameGroupIndex({
            name: 'indexVideo',
            index: index
          })
        },

        // //消息点击切换Tab
        // setFramehome: function (index) {
        //   api.setFrameGroupIndex({
        //     name: 'indexMessage',
        //     index: index
        //   })
        // },

        // 在我的页面查看我的详情页面
        openDetail: function () {
          api.openWin({
            name: 'setting_user_home',
            url: 'setting_user_home.html',
            slidBackEnabled: false,
            pageParam: {
              member_id: $api.getStorage('uid')
            }
          })
        }
      },
    })
  }
</script>